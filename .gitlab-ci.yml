---
include:
  - project: 'rahome/gitlab-ci-templates'
    ref: main
    file:
      - '/templates/Docker.gitlab-ci.yml'
      - '/templates/Yaml.gitlab-ci.yml'
  - project: 'rahome/trivy-cache'
    ref: main
    file: '/Trivy.gitlab-ci.yml'

lint:dockerfile:
  rules:
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
      when: never
    - if: '$CI_COMMIT_BRANCH'
  extends:
    - .docker-lint
  needs: []

lint:yaml:
  rules:
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
      when: never
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'
  extends:
    - .yaml-lint
  needs: []

build:
  rules:
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
      when: never
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'
  image: klakegg/hugo:0.107.0-ubuntu-ci
  needs: []
  before_script:
    - hugo version
  script:
    - hugo -d public_html
  artifacts:
    paths:
      - public_html
  variables:
    GIT_SUBMODULE_STRATEGY: recursive
  tags:
    - docker

registry:
  rules:
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
      when: never
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'
  extends:
    - .docker-registry
  needs:
    - job: build

sast:trivy:
  extends:
    - .trivy
  allow_failure: true
  rules:
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
      when: always
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'
  needs:
    - job: registry
      optional: true
      artifacts: false
